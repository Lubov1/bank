<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">


<head>
    <meta charset="UTF-8" />
    <title>Корзина товаров</title>
    <script defer>
        let currencies = [];

        async function loadRates() {
            const td = document.getElementById('exchange_rates');
            try {
                const currentSelections = {};
                document.querySelectorAll('.currencies-select').forEach((sel, index) => {
                    currentSelections[`select_${index}`] = sel.value;
                });

                const resp = await fetch('http://localhost:8083/api/public/exchange');
                const json = await resp.json();

                const rates = Object.values(json);
                currencies = rates.map(r => r.name);

                document.querySelectorAll('.currencies-select').forEach((sel, index) => {
                    const previousValue = currentSelections[`select_${index}`];
                    sel.innerHTML = currencies.map(c => `<option value="${c}">${c}</option>`).join('');

                    // Восстанавливаем предыдущее значение, если оно всё ещё существует в списке
                    if (previousValue && currencies.includes(previousValue)) {
                        sel.value = previousValue;
                    } else if (currencies.length > 0) {
                        // Иначе устанавливаем первое значение (USD)
                        sel.value = currencies[0];
                    }
                });

                // рисуем таблицу курсов
                let table = '<table style="width:100%;margin:0 auto;border-radius:2%;padding:10px;background-color:whitesmoke;">';
                table += '<tr><th colspan="3">Курсы валют по отношению к рублю</th></tr>';
                table += '<tr><th>Валюта</th><th>Обозначение</th><th>Курс</th></tr>';
                rates.forEach(r => {
                    table += `<tr><td>${r.title}</td><td>${r.name}</td><td>${r.value}</td></tr>`;
                });
                table += '</table>';
                td.innerHTML = table;

                console.log("Currencies loaded:", currencies);
            } catch (e) {
                if (td) td.textContent = 'Ошибка при получении данных курсов валют: ' + e;
                console.error("Error loading rates:", e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadRates();
            // Увеличиваем интервал до 30 секунд или больше, если не нужны частые обновления
            setInterval(loadRates, 30000); // 30 секунд
        });
    </script>
</head>

<body>
<br>
<a th:href="@{http://localhost:8083/{login}/logout(login=${login})}" style="float:right;">
    <b>ВЫЙТИ &cudarrr;</b>
</a>
<table style="width:70%;margin-left:auto;margin-right:auto;">
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'http://localhost:8083/'+login+'/editPassword'}">
        <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
            <div th:replace="~{alerts :: alerts}"></div>
            <tr>
                <td style="font-weight:bold;">Логин</td>
                <td colspan="2" th:text="${login}"/>
            </tr>
            <tr>
                <td style="font-weight:bold;">Изменить пароль</td>
                <td>
                    <p style="color:red;" th:if="${passwordErrors!=null}" th:each="passwordError : ${passwordErrors}" th:text="${passwordError}"/>
                    <p>
                        Пароль: <input name="password" type="password" required/>
                    </p>
                    <p>
                        Повторите пароль: <input name="secondPassword" type="secondPassword" required/>
                    </p>
                </td>
                <td style="text-align:right">
                    <button>Изменить пароль</button>
                </td>
            </tr>
        </table>
        </form>
    </td>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'http://localhost:8083/'+login+'/addAccount'}">
        <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
            <tr>
                <td style="font-weight:bold;">Добавить аккаунт</td>
                <td>
                    Валюта
                    <select class="currencies-select" name="currency"></select>
                </td>
                <td style="text-align:right">
                    <button>Добавить аккаунт</button>
                </td>
            </tr>
        </table>
        </form>
    </td>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'http://localhost:8083/'+login+'/deleteAccount'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr>
                    <td style="font-weight:bold;">Удалить аккаунт</td>
                    <td>
                        Валюта
                        <select class="currencies-select" name="currency"></select>
                    </td>
                    <td style="text-align:right">
                        <button>Удалить аккаунт</button>
                    </td>
                </tr>
            </table>
        </form>
    </td>

    <tr><td style="padding:2px;">
        <form method="post" th:action="${'http://localhost:8083/'+login+'/editUserAccounts'}">
        <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
            <tr th:if="${userAccountsErrors!=null}" th:each="userAccountsError : ${userAccountsErrors}">
                <td style="color:red;" th:text="${userAccountsError}"/>
            </tr>
            <tr>
                <td style="font-weight:bold;">Фамилия Имя</td>
                <td th:text="${name}"/>
                <td>
                    <input name="name" type="text" style="width:100%"/>
                </td>
            </tr>
            <tr>
                <td style="font-weight:bold;">Дата рождения</td>
                <td>
                    <input type="date" name="birthdate" style="width:100%" required/>
                </td>
            </tr>
            <tr th:each="account : ${accounts}">
                <td style="font-weight:bold;" th:text="${account.getCurrency()}"></td>
                <td th:text="${account.getBalance()+' '+account.getCurrency()}"></td>
            </tr>
            <tr>
                <td style="text-align:right" colspan="3">
                    <button>Сохранить изменения</button>
                </td>
            </tr>
        </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'http://localhost:8083/cash/'+login}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">

                <tr th:if="${cashErrors!=null}" th:each="cashError : ${cashErrors}">
                    <td style="color:red;" th:text="${cashError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Наличные</td>
                    <td>
                        Валюта
                        <select class="currencies-select" name="currency"></select>
                    </td>
                    <td>
                        <input name="amount" type="number" style="width:100%" required/>
                    </td>
                    <td>
                    <td style="text-align:right">
                        <button name="action" value="PUT">Положить</button>
                        <button name="action" value="GET">Снять</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'http://localhost:8083/'+login+'/transfer'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">

                <tr th:if="${transferErrors!=null}" th:each="transferError : ${transferErrors}">
                    <td style="color:red;" th:text="${transferError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Перевод себе</td>
                    <td>
                        Со счета
                            <select class="currencies-select" name="currencyFrom"></select>
                    <td>
<!--                    Со счета-->
<!--                        <select id="currenciesSelect" name="currency"></select>-->
<!--                        <div id="currencies" style="margin-top:6px;"></div>-->
<!--                    </td>-->
<!--                    </td>-->
                    <td>
                        На счет
                            <select class="currencies-select" name="currencyTo"></select>
                    </td>
                    <td>
                        <input name="amount" type="number" style="width:100%" required/>
                    </td>
                    <td style="text-align:right">
                        <input hidden name="loginTo" th:value="${login}"/>
                        <button>Перевести</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'http://localhost:8083/'+login+'/transfer'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${transferOtherErrors!=null}" th:each="transferOtherError : ${transferOtherErrors}">
                    <td style="color:red;" th:text="${transferOtherError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Перевод другому</td>
                    <td>
                        Со счета
                            <select class="currencies-select" name="currencyFrom"></select>
                    </td>
                    <td>
                        На счет
                            <select class="currencies-select" name="currencyTo"></select>
                    </td>
                    <td>
                        <input name="amount" type="number" required/>
                    </td>
                    <td>
                        Кому
                        <input name="loginTo" type="text" required/>
<!--                        <select name="to_login">-->
<!--                            <option th:each="user : ${users}" th:value="${user.getLogin()}" th:text="${user.getName()}"/>-->
<!--                        </select>-->
                    </td>
                    <td style="text-align:right">
                        <button>Перевести</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;" id="exchange_rates">
    </td></tr>
</table>
</body>

</html>