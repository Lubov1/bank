pipeline {
    agent any

    environment {
        GITHUB_USERNAME = credentials('GITHUB_USERNAME')
        TAG = "0.0.1"
        PLATFORM = "linux/amd64"
        DOCKER_REGISTRY = "ghcr.io/lubov1"
    }
    parameters {
        choice(
            name: 'SERVICE',
            choices: [
                'all',
                'exchange',
                'exchange-generator',
                'accounts',
                'front',
                'blocker',
                'cash',
                'notifications',
                'transfer',
                'no'
            ],
            description: 'Select which service to build & deploy'
        )
        choice(
            name: 'STAGES',
            choices: [
                'all_stages',
                'helm_stages'
            ],
            description: 'Select stages'
        )
    }

    stages {
        stage('Build & Unit Tests') {
            parallel {
                stage('Accounts') {
                    when {
                        expression { params.STAGES == 'all_stages' }
                    }
                    steps {
                        sh """
                            mvn -pl account-service -am clean test
                           """
                    }
                }
                stage('Blocker Service') {
                    when {
                        expression { params.STAGES == 'all_stages' }
                    }
                    steps {
                        sh """
                            mvn -pl blocker -am clean test
                        """
                    }
                }
            }
        }

        stage('Login to GHCR') {
            when {
                expression { params.STAGES == 'all_stages' }
            }
            steps {
                withCredentials([string(credentialsId: 'GHCR_TOKEN', variable: 'GHCR_TOKEN')]) {
                    sh '''
                        echo "$GHCR_TOKEN" | docker login ghcr.io -u Lubov1 --password-stdin
                    '''
                }
            }
        }

        stage('Build Exchange') {
            when {
                expression { params.STAGES == 'all_stages' && (params.SERVICE == 'exchange' || params.SERVICE == 'all') }
            }
            steps {
                sh '''
                    docker build -t exchange:${TAG} -f DockerfileExchange --platform ${PLATFORM} .
                    docker tag exchange:${TAG} ${DOCKER_REGISTRY}/exchange:${TAG}
                    docker push ${DOCKER_REGISTRY}/exchange:${TAG}
                '''
            }
        }

        stage('Build Exchange Generator') {
            when {
                expression { params.STAGES == 'all_stages' && (params.SERVICE == 'exchange-generator' || params.SERVICE == 'all') }
            }
            steps {
                sh '''
                    docker build -t exchange-generator:${TAG} -f DockerfileExchangeGenerator --platform ${PLATFORM} .
                    docker tag exchange-generator:${TAG} ${DOCKER_REGISTRY}/exchange-generator:${TAG}
                    docker push ${DOCKER_REGISTRY}/exchange-generator:${TAG}
                '''
            }
        }

        stage('Build Accounts') {
            when {
                expression { params.STAGES == 'all_stages' && ( params.SERVICE == 'accounts' || params.SERVICE == 'all') }
            }
            steps {
                sh '''
                    docker build -t accounts:${TAG} -f DockerfileAccountService --platform ${PLATFORM} .
                    docker tag accounts:${TAG} ${DOCKER_REGISTRY}/accounts:${TAG}
                    docker push ${DOCKER_REGISTRY}/accounts:${TAG}
                '''
            }
        }

        stage('Build Front') {
            when {
                expression { params.STAGES == 'all_stages' && (params.SERVICE == 'front' || params.SERVICE == 'all') }
            }
            steps {
                sh '''
                    docker build -t front:${TAG} -f DockerfileFront --platform ${PLATFORM} .
                    docker tag front:${TAG} ${DOCKER_REGISTRY}/front:${TAG}
                    docker push ${DOCKER_REGISTRY}/front:${TAG}
                '''
            }
        }

        stage('Build Blocker') {
            when {
                expression { params.STAGES == 'all_stages' && (params.SERVICE == 'blocker' || params.SERVICE == 'all') }
            }
            steps {
                sh '''
                    docker build -t blocker:${TAG} -f DockerfileBlocker --platform ${PLATFORM} .
                    docker tag blocker:${TAG} ${DOCKER_REGISTRY}/blocker:${TAG}
                    docker push ${DOCKER_REGISTRY}/blocker:${TAG}
                '''
            }
        }

        stage('Build Cash') {
            when {
                expression { params.STAGES == 'all_stages' && (params.SERVICE == 'cash' || params.SERVICE == 'all') }
            }
            steps {
                sh '''
                    docker build -t cash:${TAG} -f DockerfileCashService --platform ${PLATFORM} .
                    docker tag cash:${TAG} ${DOCKER_REGISTRY}/cash:${TAG}
                    docker push ${DOCKER_REGISTRY}/cash:${TAG}
                '''
            }
        }

        stage('Build Notifications') {
            when {
                expression { params.STAGES == 'all_stages' && (params.SERVICE == 'notifications' || params.SERVICE == 'all') }
            }
            steps {
                sh '''
                    docker build -t notifications:${TAG} -f DockerfileNotificationService --platform ${PLATFORM} .
                    docker tag notifications:${TAG} ${DOCKER_REGISTRY}/notifications:${TAG}
                    docker push ${DOCKER_REGISTRY}/notifications:${TAG}
                '''
            }
        }

        stage('Build Transfer') {
            when {
                expression { params.STAGES == 'all_stages' && (params.SERVICE == 'transfer' || params.SERVICE == 'all') }
            }
            steps {
                sh '''
                    docker build -t transfer:${TAG} -f DockerfileTransfer --platform ${PLATFORM} .
                    docker tag transfer:${TAG} ${DOCKER_REGISTRY}/transfer:${TAG}
                    docker push ${DOCKER_REGISTRY}/transfer:${TAG}
                '''
            }
        }

        stage('No') {
            when {
                expression { params.SERVICE == 'no' }
            }
            steps {
                sh '''
                    echo ">>> Stage skipped"
                '''
            }
        }

        stage('Kube Preflight') {
            when {
                expression { params.STAGES == 'helm_stages' ||  params.STAGES == 'all_stages'}
            }
              steps {
                  sh '''
                  export KUBECONFIG=/root/.kube/jenkins_kubeconfig.yaml
                    set -eux

                    kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}'; echo

                    echo ">>> Current context:"
                    kubectl config current-context
                    kubectl config view --minify
                    '''
              }
        }

        stage('Helm Lint') {
            when {
                expression { params.STAGES == 'helm_stages' ||  params.STAGES == 'all_stages'}
            }
            steps {
                sh """
                export KUBECONFIG=/root/.kube/jenkins_kubeconfig.yaml
                helm lint .
                """
            }
        }

        stage('Helm Deploy to PROD') {
            when {
                expression { params.STAGES == 'helm_stages' ||  params.STAGES == 'all_stages'}
            }
            steps {
                sh """
                export KUBECONFIG=/root/.kube/jenkins_kubeconfig.yaml
                kubectl get nodes
                helm install myapp ./kubernetes
                """
            }
        }
    }
}